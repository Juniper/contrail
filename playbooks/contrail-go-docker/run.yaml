- hosts: builder
  name: Build and test Juniper/contrail
  roles:
    - zuul-include-vars # include variables exported from trusted context
    - acquire-ip-address
    - self-ssh-key
    - prepare-template-for-ansible-deployer
    - contrail-ansible-deployer
    - sanitytest

  vars:
    workdir: /go/src/github.com/Juniper/contrail
    sourcedir: "{{ ansible_env.HOME }}"
    contrail_version: master-276
    contrail_docker_registry: opencontrailnightly
    setup_docker_registry: False
    cloud_orchestrator: kubernetes
    test_target: ci_k8s_sanity
  tasks:
    - include: build-setup.yaml

    - name: run
      include: build-step.yaml
      loop_control:
        label: "{{ item.name }}"
      with_items:
        - name: Install development dependencies
          command: make deps
        - name: Check vendored dependencies
          command: make check
        - name: Run the source code generator
          command: make generate
        - name: Reset databases with latest schema and load initial data
          command: make reset_db
        - name: Run tests with coverage
          command: make test
        - name: Run linters on the source code
          command: make lint
        - name: Generate Docker files
          command: make ANSIBLE_DEPLOYER_BRANCH={{ zuul.branch }} docker

    - name: Fix files ownerships
      file:
        name: "{{ sourcedir }}"
        recurse: yes
        owner: "{{ ansible_env.USER }}"
      become: yes
      become_user: root

