- hosts: builder
  tasks:
  - name: Prepare contrail version variables
    contrail_packaging:
      zuul: "{{ zuul }}"
      release_type: "{{ release_type }}"
      build_number: "{{ build_number | default('unset_build_number') }}"

- hosts: builder
  name: Build and test Juniper/contrail
  roles:
    - install-docker-daemon
  vars:
    workdir: /go/src/github.com/Juniper/contrail
    sourcedir: "{{ ansible_env.HOME }}"
  tasks:
    - include: build-setup.yaml

    - name: run
      include: build-step.yaml
      loop_control:
        label: "{{ item.name }}"
      with_items: # Insert tasks here
        - name: Install deps
          command: make deps
        - name: make generate
          command: make generate
        - name: make lint
          command: make lint
        - name: reset db
          command: make reset_db
        - name: make test
          command: make test
        - name: Make docker
          command: make docker 

    - name: Fix files ownerships
      file:
        name: "{{ sourcedir }}"
        recurse: yes
        owner: "{{ ansible_env.USER }}"
      become: yes
      become_user: root

    - name: Show built containers
      shell: docker images
      become: yes

- hosts: builder
  name: Publish containers to the internal registry
  roles:
    - publish-container-images:
        registry: "{{ docker_registry }}"
        tag: "{{ packaging.docker_version }}"
        containers:
          - { name: contrail-go, tag: latest }

