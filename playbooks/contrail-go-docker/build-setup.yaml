- name: Install docker
  pip:
    name: docker
  become: yes

- name: Install docker-compose
  pip:
    name: docker-compose
  become: yes

- name: Install npm
  yum:
    name: npm
    state: present
  become: true

- name: Install spectacle
  npm:
    name: spectacle-docs
    global: true
    production: yes
    path: /usr/local/bin
  become: yes

- name: Disable selinux for the build
  selinux:
    state: disabled
  become: yes

- name: Pretend we're using github
  command: mv {{ sourcedir }}/src/review.opencontrail.org {{ sourcedir }}/src/github.com

- name: Start runner docker container in background
  docker_container:
    name: "{{ docker.0.name|default('runner') }}"
    image: "{{ docker.0.image }}"
    state: started
    env: "{{ docker.0.environment|default(omit) }}"
    network_mode: host
    command: sleep infinity
    volumes:
      - "{{ sourcedir }}:/go"
      - "/var/run/docker.sock:/var/run/docker.sock"
  become: yes

- name: Create test environment
  command: "chdir={{ sourcedir }}/src/github.com/Juniper/contrail make testenv"
  become: yes
