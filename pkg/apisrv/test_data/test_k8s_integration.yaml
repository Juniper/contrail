name: Test k8s integration
description: |
  Integration test for k8s
cleanup:
- path: /application-policy-set/k8s-aps-uuid
- path: /network-ipam/k8s-ip-fabric-ipam-uuid
- path: /network-ipam/k8s-pod-ipam-uuid
- path: /virtual-network/k8s-default-pod-network-uuid

clients:
  default:
    id: alice
    password: alice_password
    domain: default
    insecure: true
    scope:
      project:
        name: admin

workflow:
- name: create project
  request:
    path: /projects
    method: POST
    expected: [200]
    data:
      project:
        parent_type: domain
        fq_name: ["default-domain", "k8s-default"]
        uuid: k8s-default

- name: try to create policy-management
  request:
    path: /policy-managements
    method: POST
    expected: [409]
    data:
      policy-management:
        fq_name:
        - default-policy-management
        uuid: default-policy-management

- name: get default policy management uuid from fqname
  request:
    path: /fqname-to-id
    method: POST
    expected: [200]
    data:
      fq_name: ["default-policy-management"]
      type: policy-management

- name: create application-policys-sets
  request:
    path: /application-policy-sets
    method: POST
    expected: [200]
    data:
      application-policy-set:
        parent_type: policy-management
        fq_name:
        - default-policy-management
        - k8s
        uuid: k8s-aps-uuid

- name: get default global vrouter config uuid from fqname
  request:
    path: /fqname-to-id
    method: POST
    expected: [200]
    data:
      fq_name: ["default-global-system-config", "default-global-vrouter-config"]
      type: global-vrouter-config

- name: get ip fabric network
  request:
    path: /fqname-to-id
    method: POST
    expected: [200]
    data:
      fq_name: ["default-domain", "default-project", "ip-fabric"]
      type: virtual-network

- name: create project
  request:
    path: /projects
    method: POST
    expected: [200]
    data:
      project:
        parent_type: domain
        fq_name:
        - default-domain
        - k8s-kube-system
        uuid: k8s-kube-system-uuid

- name: create network ipam
  request:
    path: /network-ipams
    method: POST
    expected: [200]
    data:
      network-ipam:
        parent_type: project
        ipam_subnets:
          subnets:
          - subnet:
              ip_prefix: 10.64.0.0
              ip_prefix_len: 12
            dns_server_address: 
            enable_dhcp: true
            created: 
            default_gateway: 
            dns_nameservers: []
            dhcp_option_list: 
            subnet_uuid: 
            alloc_unit: 1
            last_modified: 
            host_routes: 
            subscriber_tag: 
            addr_from_start: 
            subnet_name: 
            allocation_pools: []
        ipam_subnet_method: flat-subnet
        fq_name: ["default-domain", "k8s-default", "k8s-ip-fabric-ipam"]
        uuid: k8s-ip-fabric-ipam-uuid
  expect: 
    network-ipam:
      parent_uuid: k8s-default

- name: create network ipam
  request:
    path: /network-ipams
    method: POST
    expected: [200]
    data:
      network-ipam:
        parent_type: project
        ipam_subnets:
          subnets:
          - subnet:
              ip_prefix: 10.32.0.0
              ip_prefix_len: 12
            dns_server_address: 
            enable_dhcp: true
            created: 
            default_gateway: 
            dns_nameservers: []
            dhcp_option_list: 
            subnet_uuid: 
            alloc_unit: 1
            last_modified: 
            host_routes: 
            subscriber_tag: 
            addr_from_start: 
            subnet_name: 
            allocation_pools: []
        ipam_subnet_method: flat-subnet
        fq_name: ["default-domain", "k8s-default", "k8s-pod-ipam"]
        uuid: k8s-pod-ipam-uuid
  expect: 
    network-ipam:
      parent_uuid: k8s-default

- name: try to get pod network
  request:
    path: /fqname-to-id
    method: POST
    expected: [404]
    data:
      fq_name: ["default-domain", "k8s-default", "k8s-default-pod-network"]
      type: virtual-network

- name: create default pod network
  request:
    path: /virtual-networks
    method: POST
    expected: [200]
    data:
      virtual-network:
        virtual_network_properties:
          forwarding_mode: l3
          allow_transit: 
          network_id: 
          max_flow_rate: 
          mirror_destination: false
          vxlan_network_identifier: 
          max_flows: 
          rpf: 
        fq_name: ["default-domain", "k8s-default", "k8s-default-pod-network"]
        uuid: k8s-default-pod-network-uuid
        address_allocation_mode: flat-subnet-only
        parent_type: project
        network_ipam_refs:
        - to: ["default-domain", "k8s-default", "k8s-pod-ipam"]
          attr:
            ipam_subnets: []
            host_routes: 
          uuid: k8s-pod-ipam-uuid
        fabric_snat: false

- name: delete default pod network
  request:
    path: /virtual-network/k8s-default-pod-network-uuid
    method: DELETE
    expected: [204]
  expect: null

- name: delete pod ipam
  request:
    path: /network-ipam/k8s-pod-ipam-uuid
    method: DELETE
    expected: [204]
  expect: null

- name: delete ip fabric ipam
  request:
    path: /network-ipam/k8s-ip-fabric-ipam-uuid
    method: DELETE
    expected: [204]
  expect: null

- name: delete application policy set
  request:
    path: /application-policy-set/k8s-aps-uuid
    method: DELETE
    expected: [204]
  expect: null
