name: Quota checking test
description: Checking for quota overflow for all resources managed by QuotaTye
cleanup:
  - path: /virtual-network/uuid_vn_blue_spock1
  - path: /virtual-network/uuid_vn_blue_spock2
  - path: /virtual-network/uuid_vn_blue_spock3
  - path: /virtual-network/uuid_vn_green_spock
  - path: /security-group/uuid_secgrp_blue1
  - path: /security-group/uuid_secgrp_blue2
  - path: /security-group/uuid_secgrp_green
  - path: /network-ipam/uuid_ipam_magic
  - path: /network-ipam/uuid_ipam_magic_blue1
  - path: /network-ipam/uuid_ipam_magic_blue2
  - path: /project/uuid_proj_blue
  - path: /project/uuid_proj_green

test_data:
  proj_blue: &proj_blue
    uuid: uuid_proj_blue
    parent_type: domain
    parent_uuid: beefbeef-beef-beef-beef-beefbeef0002
    quota: {}
  proj_green: &proj_green
    uuid: uuid_proj_green
    parent_type: domain
    parent_uuid: beefbeef-beef-beef-beef-beefbeef0002
    quota: {}
  network_ipam_magic_blue1: &network_ipam_magic_blue1
    uuid: uuid_ipam_magic_blue1
    parent_type: project
    parent_uuid: uuid_proj_blue
  network_ipam_magic_blue2: &network_ipam_magic_blue2
    uuid: uuid_ipam_magic_blue2
    parent_type: project
    parent_uuid: uuid_proj_blue
  network_ipam_magic_green: &network_ipam_magic_green
    uuid: uuid_ipam_magic_green
    parent_type: project
    parent_uuid: uuid_proj_green
  spocknet_blue1: &spocknet_blue1
    uuid: uuid_vn_blue_spock1
    parent_type: project
    parent_uuid: uuid_proj_blue
    network_ipam_refs:
      - uuid: uuid_ipam_magic_blue1
  spocknet_blue2: &spocknet_blue2
    uuid: uuid_vn_blue_spock2
    parent_type: project
    parent_uuid: uuid_proj_blue
    network_ipam_refs:
      - uuid: uuid_ipam_magic_blue1
  spocknet_blue3: &spocknet_blue3
    uuid: uuid_vn_blue_spock3
    parent_type: project
    parent_uuid: uuid_proj_blue
    network_ipam_refs:
      - uuid: uuid_ipam_magic_blue1
  spocknet_green: &spocknet_green
    uuid: uuid_vn_green_spock
    parent_type: project
    parent_uuid: uuid_proj_green
    network_ipam_refs:
      - uuid: uuid_ipam_magic_green
  secgrp_blue1: &secgrp_blue1
    uuid: uuid_secgrp_blue1
    parent_type: project
    parent_uuid: uuid_proj_blue
    perms2:
      owner: admin
    security_group_id: 8000000
    security_group_entries:
      policy_rule:
        - direction: ">"
          protocol: tcp
          rule_sequence:
            major: 4
            minor: 1
          src_ports: [{}]
          dst_ports: [{}]
          ethertype: IPv4
          src_addresses: [{}]
          dst_addresses: [{}]
          action_list:
            simple_action: pass
  secgrp_blue2: &secgrp_blue2
    uuid: uuid_secgrp_blue2
    parent_type: project
    parent_uuid: uuid_proj_blue
    perms2:
      owner: admin
    security_group_id: 8000001
    security_group_entries: {}
  secgrp_green: &secgrp_green
    uuid: uuid_secgrp_green
    parent_type: project
    parent_uuid: uuid_proj_green
    perms2:
      owner: admin
    security_group_id: 8000002
    security_group_entries: {}
clients:
  default:
    id: alice
    password: alice_password
    domain: default
    insecure: true
    scope:
      project:
        name: admin

workflow:

# First create all necessary object for single project and most simple test case (quota should be 0)
  - name: create project blue
    request:
      path: /projects
      method: POST
      expected:
        - 201
      data:
        project: *proj_blue
    expect:
      project: *proj_blue
      
# Check quota for network_ipam
  - name: create quota for single network_ipam
    request:
      path: /project/uuid_proj_blue
      method: PUT
      expected:
        - 200
      data:
        project:
          fq_name: ["default", "blue"]
          uuid: uuid_proj_blue
          quota:
            network_ipam: 1
    expect: null
    
  - name: create ipam blue 1 (should be successful)
    request:
      path: /network-ipams
      method: POST
      expected:
        - 201
      data:
        network-ipam: *network_ipam_magic_blue1
    expect:
      network-ipam: *network_ipam_magic_blue1
      
  - name: create ipam blue 2 (shouldn't be successful)
    request:
      path: /network-ipams
      method: POST
      expected:
        - 400
        - 406
      data:
        network-ipam: *network_ipam_magic_blue2
    expect: null

  - name: Re-verify ipam blue 2 is not created
    request:
      path: /network-ipam/uuid_ipam_magic_blue2
      method: GET
      expected:
       - 404
    expect: null
    
  - name: set quota for two network_ipams
    request:
      path: /project/uuid_proj_blue
      method: PUT
      expected:
        - 200
      data:
        project:
          fq_name: ["default", "blue"]
          uuid: uuid_proj_blue
          quota:
            network_ipam: 2
    expect: null

  - name: try create ipam blue 2 again (should work now)
    request:
      path: /network-ipams
      method: POST
      expected:
        - 201
      data:
        network-ipam: *network_ipam_magic_blue2
    expect:
      network-ipam: *network_ipam_magic_blue2

  - name: delete ipam blue 2
    request:
      path: /network-ipam/uuid_ipam_magic_blue2
      method: DELETE
      expected:
        - 204
    expect: null

# Check quota for virtual_network
  - name: create virtual_network blue
    request:
      path: /virtual-networks
      method: POST
      expected:
        - 201
      data:
        virtual-network: *spocknet_blue1
    expect:
      virtual-network: *spocknet_blue1

  - name: delete virtual_network to start again with clean situation
    request:
      path: /virtual-network/uuid_vn_blue_spock1
      method: DELETE
      expected:
        - 204
    expect: null

  - name: create quota for single virtual network (update blue)
    request:
      path: /project/uuid_proj_blue
      method: PUT
      expected:
        - 200
      data:
        project:
          fq_name: ["default", "blue"]
          uuid: uuid_proj_blue
          quota:
            virtual_network: 1
    expect: null

  - name: create virtual_network blue (again)
    request:
      path: /virtual-networks
      method: POST
      expected:
        - 201
      data:
        virtual-network: *spocknet_blue1
    expect:
      virtual-network: *spocknet_blue1

  - name: create virtual_network blue2
    request:
      path: /virtual-networks
      method: POST
      expected:
        - 400
        - 406
      data:
        virtual-network: *spocknet_blue2
    expect: null

  - name: Re-verify virtal_network blue2 is not created
    request:
      path: /virtual-network/uuid_vn_blue_spock2
      method: GET
      expected:
       - 404
    expect: null

  - name: delete virtual_network
    request:
      path: /virtual-network/uuid_vn_blue_spock1
      method: DELETE
      expected:
        - 204
    expect: null

  - name: delete ipam_magic_blue1
    request:
      path: /network-ipam/uuid_ipam_magic_blue1
      method: DELETE
      expected:
        - 204
    expect: null

# Another set of tests for security group
  - name: create security_group blue 1
    request:
      path: /security-groups
      method: POST
      expected:
        - 201
      data:
        security-group: *secgrp_blue1
    expect:
      security-group: *secgrp_blue1

  - name: update quota for security_group
    request:
      path: /project/uuid_proj_blue
      method: PUT
      expected:
        - 200
      data:
        project:
          uuid: uuid_proj_blue
          quota:
            security_group: 1
    expect: null

  - name: create security_group blue 2
    request:
      path: /security-groups
      method: POST
      expected:
        - 400
        - 406
      data:
        security-group: *secgrp_blue2
    expect:
      null

  - name: Re-verify security_group blue2 is not created
    request:
      path: /security-group/uuid_secgrp_blue2
      method: GET
      expected:
       - 404
    expect: null

  - name: update quota to accept second security_group
    request:
      path: /project/uuid_proj_blue
      method: PUT
      expected:
        - 200
      data:
        project:
          uuid: uuid_proj_blue
          quota:
            security_group: 2
    expect: null

#  - name: try to create security_group blue 2 again
#    request:
#      path: /security-groups
#      method: POST
#      expected:
#        - 201
#      data:
#        security-group: *secgrp_blue2
#    expect:
#      security-group: *secgrp_blue2

# Disabled due to missing backref from project to - waiting for patches
# IPAM green not used yet
#  - name: create ipam green
#    request:
#      path: /network-ipams
#      method: POST
#      expected:
#        - 201
#      data:
#        network-ipam: *network_ipam_magic_green
#    expect:
#      network-ipam: *network_ipam_magic_green
