name: Test change ownership

description: |
  Integration test for /chown endpoint which
  handles changing objects ownership

clients:
  default:
    id: alice
    password: alice_password
    insecure: true
    scope:
      project:
        name: admin

cleanup:
  - path: /chown
  - path: /network-ipam/14efa35e-cec5-4a46-b938-12045f0cc121
  - path: /virtual-network/2b8f94e1-cb6e-4ca6-8f80-09bb161d11e2

test_data:
  bundle1: &bundle1
    uuid: 95fb658e-a628-4eb5-853b-6fede404c0ef
    owner: 2f228871-f360-4cac-979b-3b6ce74d6450

  bundle2: &bundle2
    uuid: 74dfee42-8473-4d5f-ae11-8541ed0323d3
    owner: 37d9280a-3ca4-4476-87b4-99178f8e1c8d

  bundle3: &bundle3
    uuid: e51cca61-9f6e-43a5-8c9d-8d1518cb5cbd
    owner: bf1dac11-c251-4a25-ba57-661caca18f64

  correct_chown_request: &correct_chown_request
    uuid: 2b8f94e1-cb6e-4ca6-8f80-09bb161d11e2
    owner: b8f26678-e33a-4ef6-a2d7-9fb15f5a4dc8

  admin_project: &admin_project_vmi
    uuid: fd8a8e68-df02-49f0-b444-31def29f3763
    name: admin_vmi_project
    parent_type: domain
    parent_uuid: beefbeef-beef-beef-beef-beefbeef0002
    quota: {}

  network_ipam_blue: &network_ipam_blue
    uuid: 14efa35e-cec5-4a46-b938-12045f0cc121
    display_name: test_ipam_vmi_blue
    parent_type: project
    parent_uuid: fd8a8e68-df02-49f0-b444-31def29f3763

  vn_vmi_blue: &vn_vmi_blue
    uuid: 2b8f94e1-cb6e-4ca6-8f80-09bb161d11e2
    name: vn_blue
    parent_type: project
    parent_uuid: fd8a8e68-df02-49f0-b444-31def29f3763
    network_ipam_refs:
      - uuid: 14efa35e-cec5-4a46-b938-12045f0cc121

workflow:
  - name: create project
    request:
      path: /projects
      method: POST
      expected: [200]
      data:
        project: *admin_project_vmi
    expect:
      project: *admin_project_vmi

  - name: create network ipam blue
    request:
      path: /network-ipams
      method: POST
      expected: [200]
      data:
        network-ipam: *network_ipam_blue
    expect:
      network-ipam: *network_ipam_blue

  - name: create virtual network blue
    request:
      path: /virtual-networks
      method: POST
      expected: [200]
      data:
        virtual-network: *vn_vmi_blue
    expect:
      virtual-network: *vn_vmi_blue

  - name: methods other than POST should fail (GET)
    request:
      path: /chown
      method: GET
      expected: [405]
      data:
    expect: null

  - name: methods other than POST should fail (PUT)
    request:
      path: /chown
      method: PUT
      expected: [405]
      data:
    expect: null

  - name: methods other than POST should fail (PATCH)
    request:
      path: /chown
      method: PATCH
      expected: [405]
      data:
    expect: null

  - name: methods other than POST should fail (DELETE)
    request:
      path: /chown
      method: DELETE
      expected: [405]
      data:
    expect: null

  - name: try changing ownership without passing any data
    request:
      path: /chown
      method: POST
      expected: [400]
      data:
    expect: null

  - name: try changing ownership without passing uuid in data, take 1
    request:
      path: /chown
      method: POST
      expected: [400]
      data:
        owner: e85ec999-a436-48e5-b848-42a5161aba37
        xyz: not very uuid
    expect: null

  - name: try changing ownership without passing uuid in data, take 2
    request:
      path: /chown
      method: POST
      expected: [400]
      data:
        owner: 135e8549-b6b3-4095-a66c-3f4a762812e5
    expect: null

  - name: try changing ownership without passing owner in data, take 1
    request:
      path: /chown
      method: POST
      expected: [400]
      data:
        abc: xyz
        uuid: 2b8f94e1-cb6e-4ca6-8f80-09bb161d11e2
    expect: null

  - name: try changing ownership without passing owner in data, take 2
    request:
      path: /chown
      method: POST
      expected: [400]
      data:
        uuid: 2b8f94e1-cb6e-4ca6-8f80-09bb161d11e2
    expect: null

  - name: try changing ownership of nonexistent object
    request:
      path: /chown
      method: POST
      expected: [404]
      data: *bundle1
    expect: null

  - name: try changing ownership of nonexistent object
    request:
      path: /chown
      method: POST
      expected: [404]
      data: *bundle1
    expect: null

  - name: chown virtual network
    request:
      path: /chown
      method: POST
      expected: [200]
      data: *correct_chown_request
    expect: {}

  - name: check virtual network owner
    request:
      path: /virtual-network/2b8f94e1-cb6e-4ca6-8f80-09bb161d11e2?detail=true
      method: GET
      expected:
        - 200
    expect:
      virtual-network:
        perms2:
          owner: b8f26678-e33a-4ef6-a2d7-9fb15f5a4dc8

  - name: delete virtual network
    request:
      path: /virtual-network/2b8f94e1-cb6e-4ca6-8f80-09bb161d11e2
      method: DELETE
      expected:
        - 200
    expect: null

  - name: delete network ipam blue
    request:
      path: /network-ipam/14efa35e-cec5-4a46-b938-12045f0cc121
      method: DELETE
      expected:
        - 200
    expect: null
