{% with cloudType=cloud.cloudProviderInfo.Type azure="azure" aws="aws" %}
- provider: {{ cloud.cloudProviderInfo.Type }}
  organization: {{ cloud.cloudProviderInfo.Organization }}
  project: {{ cloud.projectName }}
  regions:
  {% for region in cloud.CloudRegions %}
    - name: {{ region.Name }}
      {% ifequal cloudType azure %}
      resource_group: {{ region.ResourceGroup }}
      {% endifequal %}
      {% for vcloud in region.VirtualClouds %}
      - name: {{ vcloud.Name }}
        cidr_block: {{ vcloud.CidrBlock }}
        subnets:
        {% for subnet in vcloud.CloudPrivateSubnets %}
          - Name: {{ subnet.name }}
            cidr_block: {{ subnet.CidrBlock }}
            {% ifequal cloudType aws %}
            availability_zone: {{ subnet.AvailabilityZone }}
            {% endifequal %}
        {% endfor %}
        security_groups
        {% for sg in vcloud.CloudSecurityGroups %}
        {% if cloudType == azure %}
          - name: {{ sg.Name }}
            rules:
            {% for sgRule in sg.CloudSecurityGroupRules %}
              - name: {{ sgRule.Name }}
                direction: {{ sgRule.Direction }}
                {% if sgRule.Protocol %}protocol: {{ sgRule.Protocol }}{%}
            {% endif %}
        {% elif cloudType == aws %}
        {% for sgRule in sg.CloudSecurityGroupRules %}
          - name: {{ sgRule.Name }}
            {{ sgRule.Direction }}
              from_port: {{ sgRule.FromPort }}
              to_port: {{ sgRule.ToPort }}
              protocol: {{ sgRule.Protocol }}
              cidr_blocks:
               - {{ sgRule.CidrBlock }}
        {% endfor %}
        {% endif %}
      {% endfor %}
      {% for instance in vcloud.Nodes}
      - name: {{ instance.Name }}
        roles:
        {% if instance.ContrailConfigNodeBackRefs %}
          - controller
        {% endif %}
        {% if instance.ContrailVrouterNodeBackRefs and instance.ContrailMulticloudGWNodeBackRefs %}
          - gateway
        {% endif %}
        {% if (instance.ContrailVrouterNodeBackRefs and not instance.ContrailMulticloudGWNodeBackRefs) and instance.KubernetesNodeBackRefs %}
          - compute_node
        {% endif %}
        {% if instance.KubernetesMasterNodeBackRefs %}
          - k8s_master
        {% endif %}
        provision: true
        {% for cred in cloud.credentials %}{% for cred_ref in instance.CredentialRefs %}{%if cred_ref.UUID == cred.UUID %}
        username: {{ cred.SSHUser }}
        {% endif %}{% endfor %}{% endfor %}
        os: {{ instance.CloudInfo.OperatingSystem }}
        instance_type: {{ instance.CloudInfo.InstanceType }}
        {% ifequal cloudType aws %}
        machine_id: {{ instance.MachineID }}
        {% endifequal %}
        {% for subnet in cloud.cloudSubnets %}{% for subnet_ref in instance.CloudPrivateSubnetRefs %}{%if subnet_ref.UUID == subnet.UUID %}
        subnets: {{ instance.subnet.Name }}
        {% endif %}{% endfor %}{% endfor %}
        {% ifequal cloudType aws %}
        security_groups:
        {% for sg in cloud.cloudSecurityGroups %}{% for sg_ref in instance.CloudSecurityGroupRefs %}{% if sg_ref.UUID == sg.UUID %}
          - {{ sg.Name }}
        {% endif %}{% endfor %}{% endfor %}
        {% endifequal %}
        interface: {{ instance.InterfaceName }}
        {% endfor %}
      {% endofor %}
  {% endfor %}
{% endwith %}
