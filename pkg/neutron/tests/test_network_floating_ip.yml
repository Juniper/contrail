name: Test Neutron Network deleting Floating IPs
description: |
  Checks that Neutron Network creates and deletes floating IPs and pools.

clients:
  default:
    id: alice
    password: alice_password
    insecure: true
    scope:
      project:
        name: admin

test_data:
  project: &project
    uuid: 3a36aca6-4838-453d-abb0-5c07e0f75ea2
    name: neutron_network_floating_ip_admin_project
    parent_type: domain
    parent_uuid: beefbeef-beef-beef-beef-beefbeef0002
    quota: {}

  context: &context
    user_id: 9bd9578b25844d1ea74ddf59d2c6de8a
    roles:
    - admin
    tenant_id: 3a36aca64838453dabb05c07e0f75ea2
    is_admin: true
    tenant: 3a36aca64838453dabb05c07e0f75ea2

  network_ipam: &network_ipam
    uuid: f0987043-47b4-4ab5-84f9-bb01aa9f0ed4
    display_name: test_ipam_floating_blue
    parent_type: project
    parent_uuid: 3a36aca6-4838-453d-abb0-5c07e0f75ea2
    network_ipam_mgmt:
      host_routes:
        route:
          - prefix: "test_prefix"
            next_hop: "1.2.3.5"
    ipam_subnet_method: "user-defined-subnet"

  related_floating_ip: &related_floating_ip
    uuid: 4bb8b567-0e36-4693-b475-818cb07fa02c
    fq_name:
    - default-domain
    - neutron_network_floating_ip_admin_project
    - neutron_network_floating_ip_network
    - floating-ip-pool
    - neutron_network_floating_ip_related_floating_ip
    parent_type: floating-ip-pool
    floating_ip_address: 10.0.0.2
    project_refs:
    - uuid: 3a36aca6-4838-453d-abb0-5c07e0f75ea2

cleanup:
- path: /floating-ip/4bb8b567-0e36-4693-b475-818cb07fa02c
- path: /virtual-network/27d96cf9-b94a-4480-b5a3-1bf39ab8dd15
- path: /network-ipam/f0987043-47b4-4ab5-84f9-bb01aa9f0ed4
- path: /project/3a36aca6-4838-453d-abb0-5c07e0f75ea2

workflow:
- name: Create project
  request:
    path: /projects
    method: POST
    expected:
    - 200
    data:
      project: *project
  expect:
    project: *project

- name: Create neutron network
  request:
    path: /neutron/network
    method: POST
    expected: [200]
    data:
      data:
        fields:
        resource:
          id: 27d96cf9-b94a-4480-b5a3-1bf39ab8dd15
          router:external: true
          description: ''
          tenant_id: 3a36aca64838453dabb05c07e0f75ea2
          admin_state_up: true
          policys: ''
          vpc:route_table: ''
          shared: false
          port_security_enabled: true
          project_id: 3a36aca64838453dabb05c07e0f75ea2
          name: neutron_network_floating_ip_network
        filters:
      context:
        <<: *context
        request_id: req-e745949a-064b-4611-b99e-d1fe8932223d
        operation: CREATE
        type: network
  expect:
    status: ACTIVE
    router:external: true
    subnets: []
    fq_name:
    - default-domain
    - neutron_network_floating_ip_admin_project
    - neutron_network_floating_ip_network
    name: neutron_network_floating_ip_network
    admin_state_up: true
    tenant_id: 3a36aca64838453dabb05c07e0f75ea2
    created_at:
    updated_at:
    port_security_enabled: true
    shared: false
    project_id: 3a36aca64838453dabb05c07e0f75ea2
    id: 27d96cf9-b94a-4480-b5a3-1bf39ab8dd15
    description: ''

- name: check the created floating IP pool
  request:
    path: "/floating-ip-pools?parent_id=27d96cf9-b94a-4480-b5a3-1bf39ab8dd15&filters=name==floating-ip-pool"
    method: GET
    expected:
    - 200
  expect:
    floating-ip-pools:
    - name: floating-ip-pool
      fq_name:
      - default-domain
      - neutron_network_floating_ip_admin_project
      - neutron_network_floating_ip_network
      - floating-ip-pool
      parent_uuid: 27d96cf9-b94a-4480-b5a3-1bf39ab8dd15
      parent_type: virtual-network
      perms2:
        owner: 27d96cf9-b94a-4480-b5a3-1bf39ab8dd15
        owner_access: 7
        global_access: 5

- name: create network ipam blue
  request:
    path: /network-ipams
    method: POST
    expected:
    - 200
    data:
      network-ipam: *network_ipam
  expect:
    network-ipam: *network_ipam

- name: update the network with a subnet
  request:
    path: /virtual-network/27d96cf9-b94a-4480-b5a3-1bf39ab8dd15
    method: PUT
    expected: [200]
    data:
      virtual-network:
        network_ipam_refs:
        - uuid: f0987043-47b4-4ab5-84f9-bb01aa9f0ed4
          attr:
            ipam_subnets:
            - subnet_uuid: "054ca01e-cef3-444e-b4d5-4ac16554ac3d" # TODO Change this UUID
              subnet:
                ip_prefix: "10.0.0.0"
                ip_prefix_len: 24
              allocation_pools:
              - start: "10.0.0.0"
                end: "10.0.0.255"
  expect:
    virtual-network:
      network_ipam_refs:
      - uuid: f0987043-47b4-4ab5-84f9-bb01aa9f0ed4

- name: create a floating IP in the network's pool
  request:
    path: /floating-ips
    method: POST
    expected:
    - 200
    data:
      floating-ip:
        *related_floating_ip
  expect:
    floating-ip:
      *related_floating_ip

- name: check that the network's pool has the IP as a child
  request:
    path: "/floating-ip-pools?parent_id=27d96cf9-b94a-4480-b5a3-1bf39ab8dd15&filters=name==floating-ip-pool&detail=true"
    method: GET
    expected:
    - 200
  expect:
    floating-ip-pools:
    - floating-ip-pool:
        fq_name:
        - default-domain
        - neutron_network_floating_ip_admin_project
        - neutron_network_floating_ip_network
        - floating-ip-pool
        floating_ips:
        - uuid: 4bb8b567-0e36-4693-b475-818cb07fa02c
          name: neutron_network_floating_ip_related_floating_ip

- name: Delete neutron network
  request:
    path: /neutron/network
    method: POST
    expected: [200]
    data:
      data:
        fields:
        id: 27d96cf9-b94a-4480-b5a3-1bf39ab8dd15
        filters:
      context:
        <<: *context
        request_id: req-36c2ed1d-9fe5-4b21-b647-8dd6039f60e0
        operation: DELETE
        type: network
  expect: null

- name: check that the related floating IP has been deleted
  request:
    path: /floating-ip/4bb8b567-0e36-4693-b475-818cb07fa02c
    method: GET
    expected:
    - 404

# TODO Make an unrelated floating IP (in a different pool)
#      and check that it is not deleted.

- name: delete network ipam blue
  request:
    path: /network-ipam/f0987043-47b4-4ab5-84f9-bb01aa9f0ed4
    method: DELETE
    expected:
    - 200
  expect: null

- name: Delete project
  request:
    path: /project/3a36aca6-4838-453d-abb0-5c07e0f75ea2
    method: DELETE
    expected: [200]
